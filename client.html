<html>
    <head>
        <title>WebSocket</title>
        <style type="text/css">
            html,body {
                font:normal 0.9em arial,helvetica;
            }
            #log {
                width:600px; 
                height:300px; 
                border:1px solid #7F9DB9; 
                overflow:auto;
            }
            #msg {
                width:400px;
            }
        </style>
        <script type="text/javascript">
            var socket;

            function init() {
                var host = "ws://192.168.1.171:9000/";
                try {
                    socket = new WebSocket(host);
                    log('WebSocket - status '+socket.readyState);

                    socket.onopen    = function(msg) {
                        log("Welcome - status "+this.readyState); 
                    };

                    socket.onmessage = function(msg) { 
                        var jsonMsg =JSON.parse(msg.data);
                        if(jsonMsg.device){
                            if(jsonMsg.image){
                                showImage(jsonMsg.image);
                            }else{
                                addButton(jsonMsg.device, jsonMsg.id);                                
                            }
                        }
                        log("Received: "+msg.data); 
                    };

                    socket.onclose   = function(msg) { 
                        log("Disconnected - status "+this.readyState); 
                    };
                }
                catch(ex){ 
                    log(ex); 
                }
                $("msg").focus();
            }

            function send(){
                var txt,msg;
                txt = $("msg");
                msg = txt.value;
                if(!msg) { 
                    alert("Message can not be empty"); 
                    return; 
                }
                txt.value="";
                txt.focus();
                try { 
                    socket.send(msg); 
                    log('Sent: '+msg); 
                } catch(ex) { 
                    log(ex); 
                }
            }

            function quit(){
                if (socket != null) {
                    log("Goodbye!");
                    socket.close();
                    socket=null;
                }
            }

            function reconnect() {
                quit();
                init();
            }

            //Agregar Boton con el nombre del dispositivo
            function addButton(device, id){
                var element = document.createElement("input");
                element.setAttribute('type','button');
                element.setAttribute('name',device);
                element.setAttribute('value',device);
                element.onclick = function() {
                    requestCapture(id, device, "capture");
                };
                document.getElementById("myBody").appendChild(element);

            }

            //Pedir Screenshot del dispositivo device
            function requestCapture(id, device, type){
                try { 
                    var json = '{"id":"'+id+'","type":"'+type+'","device":"'+device+'"}';
                    socket.send(json); 
                    log('Sent: '+msg); 
                } catch(ex) { 
                    log(ex); 
                }
            }
            
            //Mostrar en pantalla el screenshot capturado
            function showImage(result){
                console.log(result);
            }

            // Utilities
            function $(id){ return document.getElementById(id); }
            function log(msg){ $("log").innerHTML+="<br>"+msg; }
            function onkey(event){ if(event.keyCode==13){ send(); } }
        </script>

    </head>
    <body onload="init()" id="myBody">
        <h3>WebSocket v2.00</h3>
        <div id="log"></div>
        <input id="msg" type="textbox" onkeypress="onkey(event)"/>
        <button onclick="send()">Send</button>
        <button onclick="quit()">Quit</button>
        <button onclick="reconnect()">Reconnect</button>
        <img id="captureResult"> 
    </body>
</html>