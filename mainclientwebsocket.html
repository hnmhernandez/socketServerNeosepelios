<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>WebSocket</title>
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript">
            var socket;
            var ArrayFingerPrints = [];

            function init() {
                /*SERVER LOCAL*/
                var host = "ws://192.168.1.171:9000/";

                /*SERVER REMOTO*/
                //                var host = "ws://138.36.236.142:9999/";

                try {
                    socket = new WebSocket(host);
                    log('WebSocket - status '+socket.readyState);

                    socket.onopen    = function(msg) {
                        log("Welcome - status "+this.readyState);
                        var json = '{"device":"server"}';
                        socket.send(json); 
                        log('Sent: '+json); 
                    };

                    socket.onmessage = function(msg) { 
                        var jsonMsg =JSON.parse(msg.data);
                        if(jsonMsg.action == "GETALLDEVICES"){
                            for (var i = 0; i<jsonMsg.devices.length;i++){
                                if(jsonMsg.devices[i].device != ""){
                                    addButton(jsonMsg.devices[i].device, jsonMsg.devices[i].id, jsonMsg.devices[i].fingerPrint, jsonMsg.devices[i].status);                                     
                                }
                            }
                        }else if(jsonMsg.action == "DISCONNETED"){
                            document.getElementById(jsonMsg.devices[0].device).disabled = true;
                        }else{
                            if(jsonMsg.device){
                                if(jsonMsg.image){
                                    showImage(jsonMsg.image);
                                }else{
                                    addButton(jsonMsg.device, jsonMsg.id, jsonMsg.fingerPrint , jsonMsg.status);  
                                }
                            }
                        }
                        log("Received: "+msg.data); 
                    };

                    socket.onclose   = function(msg) { 
                        log("Disconnected - status "+this.readyState); 
                    };
                }
                catch(ex){ 
                    log(ex); 
                }
                $("msg").focus();
            }

            function send(){
                socket.send("GETALLDEVICES"); 

                //                var txt,msg;
                //                txt = $("msg");
                //                msg = txt.value;
                //                if(!msg) { 
                //                    alert("Message can not be empty"); 
                //                    return; 
                //                }
                //                txt.value="";
                //                txt.focus();
                //                try { 
                //                    socket.send(msg); 
                //                    log('Sent: '+msg); 
                //                } catch(ex) { 
                //                    log(ex); 
                //                }
            }

            function quit(){
                if (socket != null) {
                    log("Goodbye!");
                    socket.close();
                    socket=null;
                }
            }

            function reconnect() {
                quit();
                init();
            }

            //Agregar Boton con el nombre del dispositivo
            function addButton(device, id, fingerPrint, status){
                var i = 0;
                var found = false;
                while(i<ArrayFingerPrints.length && !found){
                    if(ArrayFingerPrints[i] == fingerPrint){
                        found = true;
                    }else{
                        i++;
                    }
                }

                if(found){
                    document.getElementById(device).onclick = function(){
                        requestCapture(id, device, fingerPrint, "capture");
                    };
                    document.getElementById(device).disabled = false;
                }else{
                    ArrayFingerPrints.push(fingerPrint);
                    var element = document.createElement("input");
                    element.setAttribute('type','button');
                    element.setAttribute('name',device);
                    element.setAttribute('id',device);
                    element.setAttribute('value',device);
                    element.onclick = function() {
                        requestCapture(id, device, fingerPrint, "capture");
                    };
                    if(status == 0){
                        element.disabled = true;
                    }else{
                        element.disabled = false;
                    }
                    document.getElementById("myBody").appendChild(element);
                }
            }

            //Pedir Screenshot del dispositivo device
            function requestCapture(id, device, fingerPrint, type){
                try { 
                    var json = '{"id":"'+id+'","type":"'+type+'","device":"'+device+'","fingerPrint":"'+fingerPrint+'"}';
                    socket.send(json); 
                    log('Sent: '+msg); 
                } catch(ex) { 
                    log(ex); 
                }
            }

            //Mostrar en pantalla el screenshot capturado
            function showImage(result){
                document.getElementById("captureResult").src=result;
            }

            // Utilities
            function $(id){ return document.getElementById(id); }
            function log(msg){ $("log").innerHTML+="<br>"+msg; }
            function onkey(event){ if(event.keyCode==13){ send(); } }
        </script>

    </head>
    <body onload="init()" id="myBody">
        <h3>WebSocket v2.00</h3>
        <div id="log"></div>
        <input id="msg" type="textbox" onkeypress="onkey(event)"/>
        <button onclick="send()">Send</button>
        <button onclick="quit()">Quit</button>
        <button onclick="reconnect()">Reconnect</button>

        <div class="box">
            <a class="button" href="#popup1">Let me Pop up</a>
        </div>

        <div id="popup1" class="overlay">
            <div class="popup">
                <h2>Here i am</h2>
                <a class="close" href="#">&times;</a>
                <div class="content">
                    <img id="captureResult"> 
                </div>
            </div>
        </div>  

    </body>
</html>